<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supply and Demand Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Leaflet CSS –∏ JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse –¥–ª—è CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    #map {
      height: 90vh;
      display: none;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #versionIndicator {
      font-size: 2rem;
      text-align: center;
      margin-top: 1rem;
    }
    .upload {
      padding: 1rem;
    }
    .upload label {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    #loading {
      display: none;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      z-index: 1000;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ccc;
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    #showMapButton {
      display: none;
      margin: 1rem;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–µ—Ä—Å–∏–∏ (–Ω–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞) -->
<div id="versionIndicator">üõ†Ô∏è</div>

<!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ (Supply CSV: Contractors) -->
<div class="upload">
  <label for="supplyFile">Upload Supply CSV (Contractors):</label>
  <input type="file" id="supplyFile" accept=".csv" />
</div>

<!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Å–ø—Ä–æ—Å–∞ (Demand CSV: ZIP / Postal Code, Total Searches) -->
<div class="upload">
  <label for="demandFile">Upload Demand CSV (ZIP / Postal Code, Total Searches):</label>
  <input type="file" id="demandFile" accept=".csv" />
</div>

<div id="loading">
  Loading... <span id="progressText"></span>
  <div class="spinner"></div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç—ã -->
<button id="showMapButton">Show map</button>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
<div id="map"></div>

<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  let mapInitialized = false;
  let map;
  const loading = document.getElementById('loading');
  const progressText = document.getElementById('progressText');
  const showMapButton = document.getElementById('showMapButton');
  
  // –°–ª–æ–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å–ø—Ä–æ—Å–∞
  let supplyLayer = L.layerGroup();
  let demandLayer = L.layerGroup();
  
  // –ú–∞—Å—Å–∏–≤—ã –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥–≥–æ–Ω–∫–∏ –∫–∞—Ä—Ç—ã
  let supplyBounds = [];
  let demandBounds = [];
  
  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É ‚Äì –ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
  const MAX_SUPPLY = 100;
  const MAX_DEMAND = 100;
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ ZIP —á–µ—Ä–µ–∑ API Zippopotam.us
  async function getCoordinates(zip) {
    try {
      const res = await