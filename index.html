<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supply and Demand Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Leaflet CSS –∏ JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse –¥–ª—è CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    #map {
      height: 90vh;
      display: none;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #versionIndicator {
      font-size: 2rem;
      text-align: center;
      margin-top: 1rem;
    }
    .upload {
      padding: 1rem;
    }
    .upload label {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    #loading {
      display: none;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      z-index: 1000;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ccc;
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    #showMapButton {
      display: none;
      margin: 1rem;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–µ—Ä—Å–∏–∏ (–Ω–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞) -->
<div id="versionIndicator">üî®</div>

<!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ (Supply CSV: Contractors) -->
<div class="upload">
  <label for="supplyFile">Upload Supply CSV (Contractors):</label>
  <input type="file" id="supplyFile" accept=".csv" />
</div>

<!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Å–ø—Ä–æ—Å–∞ (Demand CSV: ZIP / Postal Code, Total Searches) -->
<div class="upload">
  <label for="demandFile">Upload Demand CSV (ZIP / Postal Code, Total Searches):</label>
  <input type="file" id="demandFile" accept=".csv" />
</div>

<div id="loading">
  Loading... <span id="progressText"></span>
  <div class="spinner"></div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç—ã -->
<button id="showMapButton">Show map</button>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
<div id="map"></div>

<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  let mapInitialized = false;
  let map;
  const loading = document.getElementById('loading');
  const progressText = document.getElementById('progressText');
  const showMapButton = document.getElementById('showMapButton');
  
  // –°–ª–æ–∏ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å–ø—Ä–æ—Å–∞
  let supplyLayer = L.layerGroup();
  let demandLayer = L.layerGroup();
  
  // –ú–∞—Å—Å–∏–≤—ã –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥–≥–æ–Ω–∫–∏ –∫–∞—Ä—Ç—ã
  let supplyBounds = [];
  let demandBounds = [];
  
  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Äì –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
  const MAX_SUPPLY = 100;
  const MAX_DEMAND = 100;
  
  // –§–ª–∞–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
  let supplyDone = false;
  let demandDone = false;
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ ZIP —á–µ—Ä–µ–∑ API Zippopotam.us
  async function getCoordinates(zip) {
    try {
      const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
      if (!res.ok) return null;
      const data = await res.json();
      const lat = parseFloat(data.places[0].latitude);
      const lon = parseFloat(data.places[0].longitude);
      return { lat, lon };
    } catch (err) {
      console.error(`Error fetching ZIP ${zip}:`, err);
      return null;
    }
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ CSV –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ (Supply)
  document.getElementById('supplyFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è supply
    supplyLayer.clearLayers();
    supplyBounds = [];
    supplyDone = false;
    
    loading.style.display = 'block';
    progressText.textContent = 'Processing Supply...';
    
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      preview: MAX_SUPPLY,
      complete: async function(results) {
        const rows = results.data; // —É–∂–µ –º–∞–∫—Å–∏–º—É–º 100 —Å—Ç—Ä–æ–∫
        let processedCount = 0;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row["Zip code (of service area)"]) continue;
          // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ ZIP, –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π
          const zip = row["Zip code (of service area)"].split(",")[0].trim();
          const coords = await getCoordinates(zip);
          if (coords) {
            supplyBounds.push([coords.lat, coords.lon]);
            L.marker([coords.lat, coords.lon])
              .bindPopup(`Contractor<br>ZIP: ${zip}`)
              .addTo(supplyLayer);
            processedCount++;
            progressText.textContent = `Supply: Processed ${processedCount} of ${rows.length}`;
          }
        }
        supplyDone = true;
        checkProcessingComplete();
      }
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ CSV –¥–ª—è —Å–ø—Ä–æ—Å–∞ (Demand)
  document.getElementById('demandFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è demand
    demandLayer.clearLayers();
    demandBounds = [];
    demandDone = false;
    
    loading.style.display = 'block';
    progressText.textContent = 'Processing Demand...';
    
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      preview: MAX_DEMAND,
      complete: async function(results) {
        const rows = results.data; // —É–∂–µ –º–∞–∫—Å–∏–º—É–º 100 —Å—Ç—Ä–æ–∫
        let processedCount = 0;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row["Zip / Postal Code"]) continue;
          const zip = row["Zip / Postal Code"].trim();
          const searches = parseFloat(row["Total Searches"]) || 0;
          const coords = await getCoordinates(zip);
          if (coords) {
            demandBounds.push([coords.lat, coords.lon]);
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø—Ä–æ—Å –∫–∞–∫ –∫—Ä—É–≥ —Å —Ä–∞–¥–∏—É—Å–æ–º, –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, searches * 2000 –º)
            L.circle([coords.lat, coords.lon], {
              radius: searches * 2000,
              color: 'red',
              fillOpacity: 0.3
            })
            .bindPopup(`Demand<br>ZIP: ${zip}<br>Total Searches: ${searches}`)
            .addTo(demandLayer);
            processedCount++;
            progressText.textContent = `Demand: Processed ${processedCount} of ${rows.length}`;
          }
        }
        demandDone = true;
        checkProcessingComplete();
      }
    });
  });
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
  function checkProcessingComplete() {
    if (supplyDone && demandDone) {
      loading.style.display = 'none';
      progressText.textContent = '';
      showMapButton.style.display = 'inline-block';
    }
  }
  
  // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É —Å –æ–±–æ–∏–º–∏ —Å–ª–æ—è–º–∏
  showMapButton.addEventListener('click', function() {
    document.getElementById('map').style.display = 'block';
    showMapButton.style.display = 'none';
    
    if (!mapInitialized) {
      map = L.map('map').setView([39.8283, -98.5795], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      mapInitialized = true;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Å–ª–æ—è –Ω–∞ –∫–∞—Ä—Ç—É
    supplyLayer.addTo(map);
    demandLayer.addTo(map);
    
    // –°–æ–∑–¥–∞–µ–º –æ–±—â–∏–π bounds –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥–≥–æ–Ω–∫–∏ –∫–∞—Ä—Ç—ã
    const allBounds = supplyBounds.concat(demandBounds);
    if (allBounds.length > 0) {
      map.fitBounds(allBounds);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–ª–æ–µ–≤
    const baseLayers = {};
    const overlayLayers = {
      "Supply": supplyLayer,
      "Demand": demandLayer
    };
    L.control.layers(baseLayers, overlayLayers).addTo(map);
  });
</script>

</body>
</html>